#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

meta:
  version: "1.0"

# Test that set-body can replace origin server response bodies.
# Previously, set-body only worked for ATS-generated responses because
# TSHttpTxnErrorBodySet() sets internal_msg_buffer which was only consumed
# by setup_internal_transfer(). With the fix, handle_api_return() checks
# internal_msg_buffer in the SERVER_READ path and diverts to
# setup_internal_transfer() instead of the origin body tunnel.

autest:
  description: 'Test set-body replacing origin server response bodies'

  dns:
    name: 'dns'

  server:
    name: 'server'

  client:
    name: 'client'
    process_config:
      other_args: '--thread-limit 1'

  ats:
    name: 'ts'

    copy_to_config_dir:
      - 'rules'

    records_config:
      proxy.config.http.insert_response_via_str: 0
      proxy.config.http.cache.http: 0
      proxy.config.diags.debug.enabled: 1
      proxy.config.diags.debug.tags: 'http|header_rewrite'

    remap_config:
      # Test 1: set-body at SEND_RESPONSE_HDR replacing origin 403 body
      - from: "http://www.example.com/set_body_send_resp_403/"
        to: "http://backend.ex:{SERVER_HTTP_PORT}/origin_403/"
        plugins:
          - name: "header_rewrite.so"
            args:
              - "rules/rule_set_body_origin_send_resp.conf"

      # Test 2: set-body at READ_RESPONSE_HDR replacing origin 403 body
      - from: "http://www.example.com/set_body_read_resp_403/"
        to: "http://backend.ex:{SERVER_HTTP_PORT}/origin_403/"
        plugins:
          - name: "header_rewrite.so"
            args:
              - "rules/rule_set_body_origin_read_resp.conf"

      # Test 3: set-body at SEND_RESPONSE_HDR replacing origin 200 body
      - from: "http://www.example.com/set_body_send_resp_200/"
        to: "http://backend.ex:{SERVER_HTTP_PORT}/origin_200/"
        plugins:
          - name: "header_rewrite.so"
            args:
              - "rules/rule_set_body_origin_send_resp.conf"

      # Test 4: set-body at SEND_RESPONSE_HDR with origin empty body (Content-Length: 0)
      - from: "http://www.example.com/set_body_empty_origin/"
        to: "http://backend.ex:{SERVER_HTTP_PORT}/origin_empty/"
        plugins:
          - name: "header_rewrite.so"
            args:
              - "rules/rule_set_body_origin_send_resp.conf"

sessions:

# Test 1: Origin returns 403 with sensitive body, set-body at SEND_RESPONSE_HDR replaces it
- transactions:
  - client-request:
      method: "GET"
      version: "1.1"
      url: /set_body_send_resp_403/
      headers:
        fields:
        - [ Host, www.example.com ]
        - [ uuid, 1 ]

    server-response:
      status: 403
      reason: Forbidden
      headers:
        fields:
        - [ Content-Length, "39" ]
        - [ Content-Type, "text/plain" ]
      content:
        size: 39
        data: "Sensitive account info: secret-key-12345"

    proxy-response:
      status: 403
      headers:
        fields:
        - [ Content-Length, { value: "9", as: equal } ]
      content:
        size: 9
        data: "Sanitized"

# Test 2: Origin returns 403 with sensitive body, set-body at READ_RESPONSE_HDR replaces it
- transactions:
  - client-request:
      method: "GET"
      version: "1.1"
      url: /set_body_read_resp_403/
      headers:
        fields:
        - [ Host, www.example.com ]
        - [ uuid, 2 ]

    server-response:
      status: 403
      reason: Forbidden
      headers:
        fields:
        - [ Content-Length, "39" ]
        - [ Content-Type, "text/plain" ]
      content:
        size: 39
        data: "Sensitive account info: secret-key-12345"

    proxy-response:
      status: 403
      headers:
        fields:
        - [ Content-Length, { value: "9", as: equal } ]
      content:
        size: 9
        data: "Sanitized"

# Test 3: Origin returns 200 with body, set-body replaces it (works for any status)
- transactions:
  - client-request:
      method: "GET"
      version: "1.1"
      url: /set_body_send_resp_200/
      headers:
        fields:
        - [ Host, www.example.com ]
        - [ uuid, 3 ]

    server-response:
      status: 200
      reason: OK
      headers:
        fields:
        - [ Content-Length, "24" ]
        - [ Content-Type, "text/html" ]
      content:
        size: 24
        data: "Original response body!!"

    proxy-response:
      status: 200
      headers:
        fields:
        - [ Content-Length, { value: "9", as: equal } ]
      content:
        size: 9
        data: "Sanitized"

# Test 4: Origin returns 403 with empty body (Content-Length: 0), set-body adds body
- transactions:
  - client-request:
      method: "GET"
      version: "1.1"
      url: /set_body_empty_origin/
      headers:
        fields:
        - [ Host, www.example.com ]
        - [ uuid, 4 ]

    server-response:
      status: 403
      reason: Forbidden
      headers:
        fields:
        - [ Content-Length, "0" ]
        - [ Content-Type, "text/plain" ]
      content:
        size: 0

    proxy-response:
      status: 403
      headers:
        fields:
        - [ Content-Length, { value: "9", as: equal } ]
      content:
        size: 9
        data: "Sanitized"
