#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

#
# This replay file verifies auth-related caching behaviors with both default
# configuration and with ignore_authentication enabled via conf_remap
#
meta:
  version: "1.0"

# Configuration section for autest integration
autest:
  dns:
    name: 'dns-auth'
  description: 'Verify the proper caching behavior for request/response containing auth-related fields in both default and ignore_authentication configurations'

  server:
    name: 'auth-verifier-server'

  client:
    name: 'auth-client'

  ats:
    name: 'ts-auth'
    process_config:
      enable_cache: true

    records_config:
      proxy.config.diags.debug.enabled: 1
      proxy.config.diags.debug.tags: 'http'
      # Default behavior: respect WWW-Authenticate (don't cache)
      proxy.config.http.cache.ignore_authentication: 0

    remap_config:
      # Default path - uses default ignore_authentication=0
      - from: "http://example.com/default/"
        to: "http://backend.example.com:{SERVER_HTTP_PORT}/default/"
      # Ignored path - overrides to ignore_authentication=1 via conf_remap
      - from: "http://example.com/ignored/"
        to: "http://backend.example.com:{SERVER_HTTP_PORT}/ignored/"
        plugins:
          - name: "conf_remap.so"
            args:
              - "proxy.config.http.cache.ignore_authentication=1"

    log_validation:
      traffic_out:
        contains:
          - expression: "response has WWW-Authenticate, response is not cacheable"
            description: "Verify ATS doesn't store the response with WWW-Authenticate in default config."

sessions:
  - transactions:
      #########################################################################
      # Test default behavior: WWW-Authenticate responses are NOT cached
      #########################################################################
      - client-request:
          method: "GET"
          version: "1.1"
          url: /default/auth
          headers:
            fields:
              - [uuid, default-www-auth-response]
              - [Host, example.com]

        server-response:
          status: 401
          reason: Unauthorized
          headers:
            fields:
              - [Content-Length, 4]
              - [Cache-Control, "max-age=5"]
              - [WWW-Authenticate, "Basic"]

        proxy-response:
          status: 401

      # Re-request to verify the previous response was NOT cached
      - client-request:
          # Add a delay so ATS has time to finish any caching IO for the
          # previous transaction.
          delay: 100ms
          method: "GET"
          version: "1.1"
          url: /default/auth
          headers:
            fields:
              - [uuid, default-www-auth-verify]
              - [Host, example.com]
              - [Authorization, "Basic ZGVtbzphdHNAc3Ryb25ncHc="]

        server-response:
          status: 200
          reason: OK

        # Verify that the new 200 response is returned instead of cached 401
        proxy-response:
          status: 200

      #########################################################################
      # Test ignore_authentication=1: WWW-Authenticate responses ARE cached
      #########################################################################
      - client-request:
          method: "GET"
          version: "1.1"
          url: /ignored/auth
          headers:
            fields:
              - [uuid, ignored-www-auth-response]
              - [Host, example.com]

        server-response:
          status: 401
          reason: Unauthorized
          headers:
            fields:
              - [Content-Length, 4]
              - [Cache-Control, "max-age=5"]
              - [WWW-Authenticate, "Basic"]

        proxy-response:
          status: 401

      # Re-request to verify the previous response WAS cached
      - client-request:
          # Add a delay so ATS has time to finish any caching IO for the
          # previous transaction.
          delay: 100ms
          method: "GET"
          version: "1.1"
          url: /ignored/auth
          headers:
            fields:
              - [uuid, ignored-www-auth-verify]
              - [Host, example.com]
              - [Authorization, "Basic ZGVtbzphdHNAc3Ryb25ncHc="]

        server-response:
          status: 200
          reason: OK

        # Verify that the cached 401 response is returned instead of new 200
        proxy-response:
          status: 401

